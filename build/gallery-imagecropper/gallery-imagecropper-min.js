YUI.add("gallery-imagecropper",function(b){var f=b.Lang,j=f.isNumber,g=b.Array,d=b.ClassNameManager.getClassName,i="imagecropper",c="resize",h="mask",a="knob",e={cropMask:d(i,h),resizeKnob:d(i,c,a),resizeMask:d(i,c,h)};b.ImageCropper=b.Base.create("imagecropper",b.Widget,[],{CONTENT_TEMPLATE:"<img/>",_toggleKeys:function(k){if(k.newVal){this._bindArrows();}else{this._unbindArrows();}},_moveResizeKnob:function(s){s.preventDefault();var B=this.get("resizeKnob"),t=this.get("contentBox"),w=B.get("offsetWidth"),C=B.get("offsetHeight"),r=s.shiftKey?this.get("shiftKeyTick"):this.get("keyTick"),A=s.direction,u=A.indexOf("w")>-1?-r:A.indexOf("e")>-1?r:0,m=A.indexOf("n")>-1?-r:A.indexOf("s")>-1?r:0,z=B.getX()+u,v=B.getY()+m,q=t.getX(),p=t.getY(),l=q+t.get("offsetWidth")-w,k=p+t.get("offsetHeight")-C,n;if(z<q){z=q;}else{if(z>l){z=l;}}if(v<p){v=p;}else{if(v>k){v=k;}}B.setXY([z,v]);n={width:w,height:C,left:B.get("offsetLeft"),top:B.get("offsetTop"),sourceEvent:s.type};n[s.type+"Event"]=s;this.fire("crop:start",n);this.fire("crop:crop",n);this.fire("crop:end",n);this._syncResizeMask();},_defCropMaskSetter:function(k){k=b.one(k);if(k){k.addClass(e.cropMask);}return k;},_defCropMaskValueFn:function(){return b.Node.create(b.ImageCropper.CROP_MASK_TEMPLATE);},_defResizeKnobSetter:function(k){k=b.one(k);if(k){k.addClass(e.resizeKnob);}return k;},_defResizeKnobValueFn:function(){return b.Node.create(b.ImageCropper.RESIZE_KNOB_TEMPLATE);},_defResizeMaskSetter:function(k){k=b.one(k);if(k){k.addClass(e.resizeMask);}return k;},_defResizeMaskValueFn:function(){return b.Node.create(b.ImageCropper.RESIZE_MASK_TEMPLATE);},_defStatusGetter:function(){var k=this._resize?this._resize.get("resizing"):false,l=this._drag?this._drag.get("dragging"):false;return k||l;},_defInitHeightValidator:function(k){return j(k)&&k>=this.get("minHeight");},_defInitWidthValidator:function(k){return j(k)&&k>=this.get("minWidth");},_renderCropMask:function(k){var l=this.get("cropMask");if(!l.inDoc()){k.append(l);}},_renderResizeKnob:function(k){var l=this.get("resizeKnob");if(!l.inDoc()){k.append(l);}l.setStyle("backgroundImage","url("+this.get("source")+")");},_renderResizeMask:function(){var k=this.get("resizeMask");if(!k.inDoc()){this.get("resizeKnob").append(k);}},_handleSrcChange:function(k){this.get("contentBox").set("src",k.newVal);this.get("resizeKnob").setStyle("backgroundImage","url("+k.newVal+")");},_syncResizeKnob:function(){var k=this.get("initialXY");this.get("resizeKnob").setStyles({left:k[0],top:k[1],width:this.get("initWidth"),height:this.get("initHeight")});},_syncResizeMask:function(){var k=this.get("resizeKnob");k.setStyle("backgroundPosition",(-k.get("offsetLeft"))+"px "+(-k.get("offsetTop"))+"px");},_syncResizeAttr:function(k){if(this._resize){this._resize.con.set(k.attrName,k.newVal);}},_icEventProxy:function(o,n,m){var l=n+":"+m,k=this.get("resizeKnob");o.on(l,function(p){var q={width:k.get("offsetWidth"),height:k.get("offsetHeight"),left:k.get("offsetLeft"),top:k.get("offsetTop")};q[n+"Event"]=p;this.fire(l,q);q.sourceEvent=l;this.fire("crop:"+(m===n?"crop":m),q);},this);},_bindArrows:function(){this._arrowHandler=this.get("resizeKnob").on("arrow",this._moveResizeKnob,this);},_unbindArrows:function(){if(this._arrowHandler){this._arrowHandler.detach();}},_bindResize:function(l,k){var m=this._resize=new b.Resize({node:l});m.on("resize:resize",this._syncResizeMask,this);m.plug(b.Plugin.ResizeConstrained,{constrain:k,minHeight:this.get("minHeight"),minWidth:this.get("minWidth"),preserveRatio:this.get("preserveRatio")});g.each(b.ImageCropper.RESIZE_EVENTS,b.bind(this._icEventProxy,this,m,"resize"));},_bindDrag:function(l,k){var m=this._drag=new b.DD.Drag({node:l,handles:[this.get("resizeMask")]});m.on("drag:drag",this._syncResizeMask,this);m.plug(b.Plugin.DDConstrained,{constrain2node:k});g.each(b.ImageCropper.DRAG_EVENTS,b.bind(this._icEventProxy,this,m,"drag"));},initializer:function(){this.set("initialXY",this.get("initialXY")||[10,10]);this.set("initWidth",this.get("initWidth"));this.set("initHeight",this.get("initHeight"));this.after("sourceChange",this._handleSrcChange);this.after("useKeysChange",this._toggleKeys);this._icHandlers=[];g.each(b.ImageCropper.RESIZE_ATTRS,function(k){this.after(k+"Change",this._syncResizeAttr);},this);},renderUI:function(){var k=this.get("boundingBox");this._renderCropMask(k);this._renderResizeKnob(k);this._renderResizeMask();},bindUI:function(){var l=this.get("contentBox"),k=this.get("resizeKnob");this._icHandlers.push(k.on("focus",this._attachKeyBehavior,this),k.on("blur",this._detachKeyBehavior,this),k.on("mousedown",k.focus,k));this._bindArrows();this._bindResize(k,l);this._bindDrag(k,l);},syncUI:function(){this.get("contentBox").set("src",this.get("source"));this._syncResizeKnob();this._syncResizeMask();},getCropCoords:function(){var l=this.get("resizeKnob"),k,m;if(l.inDoc()){k={left:l.get("offsetLeft"),top:l.get("offsetTop"),width:l.get("offsetWidth"),height:l.get("offsetHeight")};}else{m=this.get("initialXY");k={left:m[0],top:m[1],width:this.get("initWidth"),height:this.get("initHeight")};}k.image=this.get("source");return k;},reset:function(){this.get("resizeKnob").setXY(this.get("initialXY")).setStyles({width:this.get("initWidth"),height:this.get("initHeight")});this._syncResizeMask();return this;},destructor:function(){if(this._resize){this._resize.destroy();}if(this._drag){this._drag.destroy();}g.each(this._icHandlers,function(k){k.detach();});this._unbindArrows();this._drag=this._resize=null;}},{CROP_MASK_TEMPLATE:'<div class="'+e.cropMask+'"></div>',RESIZE_KNOB_TEMPLATE:'<div class="'+e.resizeKnob+'" tabindex="0"></div>',RESIZE_MASK_TEMPLATE:'<div class="'+e.resizeMask+'"></div>',RESIZE_EVENTS:["start","resize","end"],RESIZE_ATTRS:["minWidth","minHeight","preserveRatio"],DRAG_EVENTS:["start","drag","end"],HTML_PARSER:{source:function(k){return k.get("src");},cropMask:"."+e.cropMask,resizeKnob:"."+e.resizeKnob,resizeMask:"."+e.resizeMask},ATTRS:{source:{value:""},resizeMask:{setter:"_defResizeMaskSetter",valueFn:"_defResizeMaskValueFn"},resizeKnob:{setter:"_defResizeKnobSetter",valueFn:"_defResizeKnobValueFn"},cropMask:{setter:"_defCropMaskSetter",valueFn:"_defCropMaskValueFn"},initialXY:{validator:f.isArray},keyTick:{value:1,validator:j},shiftKeyTick:{value:10,validator:j},useKeys:{value:true,validator:f.isBoolean},status:{readOnly:true,getter:"_defStatusGetter"},minHeight:{value:50,validator:j},minWidth:{value:50,validator:j},preserveRatio:{value:false,validator:f.isBoolean},initHeight:{value:0,validator:"_defInitHeightValidator"},initWidth:{value:0,validator:"_defInitWidthValidator"}}});
},"gallery-2012.08.01-13-16",{skinnable:true,requires:["widget","resize","gallery-event-arrow","dd-constrain"]});